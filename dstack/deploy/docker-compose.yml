services:
  openclaw:
    image: h4x3rotab/openclaw-cvm@sha256:f0e1c170b5f122753011c1cfb47c939dbec2f65e1f1ead64a3c4c912615b39a2
    privileged: true
    ports:
      - "1022:22"
      - "18789:18789"
    volumes:
      - /home/root/.ssh:/root/.ssh:ro
      - openclaw_data:/data
      - docker_data:/var/lib/docker
      - /var/run/dstack.sock:/var/run/dstack.sock
    environment:
      NODE_ENV: production
      MASTER_KEY: ${MASTER_KEY:-}
      REDPILL_API_KEY: ${REDPILL_API_KEY:-}
      ANTHROPIC_OAUTH_TOKEN: ${ANTHROPIC_OAUTH_TOKEN:-}
      TELEGRAM_BOT_TOKEN: ${OPENCLAW_TELEGRAM_BOT_TOKEN:-}
    restart: unless-stopped
    networks:
      - internal

  oauth3-proxy:
    image: ghcr.io/amiller/oauth3-proxy@sha256:fb2a31d2a474e2e45948be21948951dbbc6b059a637e27c5a5f2239e93e0e1b2
    ports:
      - "3737:3737"
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      PORT: "3737"
      DB_PATH: /data/proxy.db
      EXECUTOR_MODE: direct
      PUBLIC_URL: https://b50173318c7332d2a7e63e66770d11b2b6e67043-3737.dstack-pha-prod7.phala.network
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    volumes:
      - oauth3_data:/data
    restart: unless-stopped
    networks:
      - internal

  ssh:
    image: ghcr.io/amiller/dstack-ssh-sidecar@sha256:619756189423e1ad1452a5606adf57ef72ac5812fcd31933fdd156e53848ab53
    privileged: true
    network_mode: host
    environment:
      SSH_PUBKEY: ${SSH_PUBKEY:-}
    volumes:
      - /:/host/
      - /var/run/dstack.sock:/var/run/dstack.sock
    restart: unless-stopped

networks:
  internal:
    driver: bridge

volumes:
  openclaw_data:
  docker_data:
  oauth3_data:
